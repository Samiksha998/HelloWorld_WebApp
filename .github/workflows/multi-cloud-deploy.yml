name: Deploy to GCP and Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # <-- enables Run Workflow button

jobs:
  multicloud-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------------------------------
    # CHECKOUT REPOSITORY
    # ---------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------------------------------
    # NODE DEPENDENCY CHECK
    # ---------------------------------------------------
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Install dependencies
      run: npm install

    - name: Dependency Vulnerability Check
      run: npm audit --audit-level=high

    # ---------------------------------------------------
    # BUILD DOCKER IMAGE (COMMON FOR BOTH CLOUDS)
    # ---------------------------------------------------
    - name: Build Docker image
      run: docker build -t helloworld-app .

    # ======================================================================
    #                    GCP CLOUD RUN DEPLOYMENT
    # ======================================================================

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Push to GCP Artifact Registry
      run: |
        docker tag helloworld-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: helloworld-cloudrun
        region: us-central1
        image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        flags: --allow-unauthenticated --port=8080

    - name: Verify Cloud Run Web App on Port 8080
      run: |
        SERVICE_URL=$(gcloud run services describe helloworld-cloudrun --region us-central1 --format='value(status.url)')
        echo "GCP_URL=$SERVICE_URL" >> $GITHUB_ENV
        echo "Cloud Run Service URL: $SERVICE_URL"
        echo ""
        echo "Testing web app response..."
        RESPONSE=$(curl -s "$SERVICE_URL")
        if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
          echo "Web app is successfully hosting on port 8080"
          echo "HTML content verified"
          echo ""
          echo "Web app is serving styled HTML page with welcome message"
        else
          echo "Web app verification failed"
          exit 1
        fi

    # ======================================================================
    #                    AZURE APP SERVICE DEPLOYMENT
    # ======================================================================

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Register Required Azure Resource Providers
      run: |
        echo "Registering Microsoft.ContainerRegistry provider..."
        az provider register --namespace Microsoft.ContainerRegistry --wait
        echo "Registering Microsoft.Web provider..."
        az provider register --namespace Microsoft.Web --wait
        echo "Resource providers registered"

    - name: Set Azure resource names (use existing plan)
      run: |
        # Use the App Service Plan and Resource Group you showed in your local 'az' output
        RG="multi-cloud-demo"
        PLAN="ASP-multiclouddemo-b415"
        echo "AZURE_RESOURCE_GROUP=$RG" >> $GITHUB_ENV
        echo "AZURE_APP_SERVICE_PLAN=$PLAN" >> $GITHUB_ENV
        # Try to detect the resource group's location and export AZURE_REGION if found
        LOCATION=$(az group show --name "$RG" --query location -o tsv 2>/dev/null || echo "")
        if [ -n "$LOCATION" ]; then
          echo "AZURE_REGION=$LOCATION" >> $GITHUB_ENV
          echo "Detected resource group location: $LOCATION"
        else
          echo "AZURE_REGION=" >> $GITHUB_ENV
          echo "Resource group $RG not found locally via az group show; subsequent steps may create or select region."
        fi

    - name: Find or Create Azure Resource Group (uses existing if present)
      run: |
        # Use provided resource group if set above; otherwise fall back to creating helloworld-rg
        RG=${{ env.AZURE_RESOURCE_GROUP }}
        if [ -n "$RG" ] && az group exists --name "$RG"; then
          echo "Resource group $RG already exists. Using existing group."
          LOCATION=$(az group show --name "$RG" --query location -o tsv)
          echo "AZURE_REGION=$LOCATION" >> $GITHUB_ENV
        else
          RG="helloworld-rg"
          REGIONS=("eastus" "westus" "southcentralus" "canadacentral" "northeurope" "westeurope")
          SELECTED_REGION=""
          echo "Attempting to find available region for new resource group..."
          for region in "${REGIONS[@]}"; do
            echo "Trying region: $region"
            if az group create --name $RG --location $region 2>&1 | grep -q "created\|already exists"; then
              SELECTED_REGION=$region
              echo "Using region: $SELECTED_REGION"
              echo "AZURE_REGION=$SELECTED_REGION" >> $GITHUB_ENV
              break
            fi
          done
          if [ -z "$SELECTED_REGION" ]; then
            echo "âŒ No available region found. All regions exhausted or error occurred."
            exit 1
          fi
          # export chosen RG name so later steps reference it
          echo "AZURE_RESOURCE_GROUP=$RG" >> $GITHUB_ENV
        fi

    - name: Create Azure Container Registry
      run: |
        ACR_NAME="helloworldacr$(date +%s | tail -c 4)"
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
        az acr create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name $ACR_NAME \
          --sku Basic

    - name: Enable ACR Admin and Login
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        echo "Enabling admin credentials on ACR: $ACR_NAME"
        az acr update -n $ACR_NAME --admin-enabled true
        echo "Logging in to ACR..."
        az acr login --name $ACR_NAME

    - name: Build and Push Docker Image to ACR
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        echo "Building Docker image for ACR: $ACR_NAME"
        docker build -t ${ACR_NAME}.azurecr.io/helloworld-app:latest .
        echo "Pushing image to ACR..."
        docker push ${ACR_NAME}.azurecr.io/helloworld-app:latest
        echo "Image pushed successfully"


    - name: Create Azure Web App
      run: |
        WEBAPP_NAME="Hellowworld-App"
        echo "WEBAPP_NAME=$WEBAPP_NAME" >> $GITHUB_ENV

        ACR_NAME=${{ env.ACR_NAME }}
        IMAGE_NAME=${ACR_NAME}.azurecr.io/helloworld-app:latest

        az webapp create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --plan ${{ env.AZURE_APP_SERVICE_PLAN }} \
          --name $WEBAPP_NAME \
          --deployment-container-image-name $IMAGE_NAME

    - name: Configure Web App Container Settings (ACR)
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        REGISTRY_URL="https://${ACR_NAME}.azurecr.io"
        USERNAME=$(az acr credential show -n $ACR_NAME --query "username" -o tsv)
        PASSWORD=$(az acr credential show -n $ACR_NAME --query "passwords[0].value" -o tsv)

        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --docker-custom-image-name ${ACR_NAME}.azurecr.io/helloworld-app:latest \
          --docker-registry-server-url $REGISTRY_URL \
          --docker-registry-server-user $USERNAME \
          --docker-registry-server-password $PASSWORD

    - name: Configure Port and Enable Container Restart
      run: |
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        echo "Configuring web app settings for $WEBAPP_NAME..."
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings WEBSITES_PORT=8080

        echo "Restarting web app to apply settings..."
        az webapp restart \
          --name $WEBAPP_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

        echo "Waiting for web app to fully start..."
        sleep 30

    - name: Display and Verify Azure Web App URL
      run: |
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        AZURE_URL="https://${WEBAPP_NAME}.azurewebsites.net"
        echo "Azure Web App URL: $AZURE_URL"
        echo "Testing web app endpoint..."

        # Retry logic for web app startup
        for i in {1..10}; do
          echo "Attempt $i"
          RESPONSE=$(curl -s -m 5 "$AZURE_URL" 2>/dev/null) || true
          if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
            echo "Azure Web App is running on port 8080"
            echo "HTML content verified"
            exit 0
          fi
          sleep 5
        done
        echo "Web app may still be starting. Check the URL manually: $AZURE_URL"

    - name: Deployment Complete
      run: |
        echo "Deployment complete. Check above steps for details and URLs."

