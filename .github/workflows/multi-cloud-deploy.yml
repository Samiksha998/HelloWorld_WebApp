name: Deploy to GCP and Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # <-- enables Run Workflow button

jobs:
  multicloud-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------------------------------
    # CHECKOUT REPOSITORY
    # ---------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------------------------------
    # NODE DEPENDENCY CHECK
    # ---------------------------------------------------
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Install dependencies
      run: npm install

    - name: Dependency Vulnerability Check
      run: npm audit --audit-level=high

    # ---------------------------------------------------
    # BUILD DOCKER IMAGE (COMMON FOR BOTH CLOUDS)
    # ---------------------------------------------------
    - name: Build Docker image
      run: docker build -t helloworld-app .

    # ======================================================================
    #                    GCP CLOUD RUN DEPLOYMENT
    # ======================================================================

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Push to GCP Artifact Registry
      run: |
        docker tag helloworld-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: helloworld-cloudrun
        region: us-central1
        image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        flags: --allow-unauthenticated --port=8080

    - name: Verify Cloud Run Web App on Port 8080
      run: |
        SERVICE_URL=$(gcloud run services describe helloworld-cloudrun --region us-central1 --format='value(status.url)')
        echo "Cloud Run Service URL: $SERVICE_URL"
        echo ""
        echo "Testing web app response..."
        RESPONSE=$(curl -s "$SERVICE_URL")
        if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
          echo "✅ Web app is successfully hosting on port 8080"
          echo "✅ HTML content verified"
          echo ""
          echo "Web app is serving styled HTML page with welcome message"
        else
          echo "❌ Web app verification failed"
          exit 1
        fi

    # ======================================================================
    #                    AZURE APP SERVICE DEPLOYMENT
    # ======================================================================

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Azure Resource Group
      run: |
        az group create \
          --name helloworld-rg \
          --location eastus

    - name: Create Azure Container Registry
      run: |
        az acr create \
          --resource-group helloworld-rg \
          --name helloworldacr \
          --sku Basic || true

    - name: Build and Push Docker Image to ACR
      run: |
        az acr build \
          --registry helloworldacr \
          --image helloworld-app:latest .

    - name: Create Azure App Service Plan
      run: |
        az appservice plan create \
          --name helloworld-asp \
          --resource-group helloworld-rg \
          --sku B1 \
          --is-linux || true

    - name: Create Azure Web App
      run: |
        az webapp create \
          --resource-group helloworld-rg \
          --plan helloworld-asp \
          --name helloworld-app-${{ github.run_id }} \
          --deployment-container-image-name helloworldacr.azurecr.io/helloworld-app:latest || true

    - name: Configure Web App Container Settings
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group helloworld-rg \
          --docker-custom-image-name helloworldacr.azurecr.io/helloworld-app:latest \
          --docker-registry-server-url https://helloworldacr.azurecr.io \
          --docker-registry-server-user $(az acr credential show -n helloworldacr --query "username" -o tsv) \
          --docker-registry-server-password $(az acr credential show -n helloworldacr --query "passwords[0].value" -o tsv)

    - name: Configure Port and Deploy
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group helloworld-rg \
          --settings WEBSITES_PORT=8080

    - name: Display Azure Web App URL
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        AZURE_URL="https://${WEBAPP_NAME}.azurewebsites.net"
        echo "✅ Azure Web App Successfully Deployed!"
        echo ""
        echo "Azure Web App URL: $AZURE_URL"
        echo ""
        echo "Testing web app..."
        sleep 10
        RESPONSE=$(curl -s "$AZURE_URL")
        if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
          echo "✅ Azure Web App is running on port 8080"
          echo "✅ HTML content verified"
        else
          echo "⏳ Web app may still be starting up"
        fi
