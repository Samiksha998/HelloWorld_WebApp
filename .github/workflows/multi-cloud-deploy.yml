name: Deploy to GCP and Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  multicloud-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------------------------------
    # CHECKOUT REPOSITORY
    # ---------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------------------------------
    # NODE DEPENDENCY CHECK
    # ---------------------------------------------------
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Install dependencies
      run: npm install

    - name: Dependency Vulnerability Check
      run: npm audit --audit-level=high

    # ---------------------------------------------------
    # BUILD DOCKER IMAGE
    # ---------------------------------------------------
    - name: Build Docker image
      run: docker build -t helloworld-app .

    # ---------------------------------------------------
    # LOGIN & PUSH TO DOCKER HUB
    # ---------------------------------------------------
    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Push image to Docker Hub
      run: |
        IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/helloworld-app:latest"
        docker tag helloworld-app $IMAGE
        docker push $IMAGE
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV

    # ======================================================================
    #                    GCP CLOUD RUN DEPLOYMENT
    # ======================================================================
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Deploy to Cloud Run (using Docker Hub image)
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: helloworld-cloudrun
        region: us-central1
        image: ${{ env.IMAGE }}
        flags: --port=8080 --allow-unauthenticated

    # --- OPTIONAL: Restrict access to specific IPs ---
    # gcloud run services update helloworld-cloudrun \
    #   --region=us-central1 \
    #   --ingress internal-and-cloud-load-balancing
    #
    # OR set IAM:
    # gcloud run services add-iam-policy-binding helloworld-cloudrun \
    #   --member="user:specific@example.com" \
    #   --role="roles/run.invoker"

    - name: Verify Cloud Run Web App
      run: |
        URL=$(gcloud run services describe helloworld-cloudrun --region us-central1 --format='value(status.url)')
        echo "Cloud Run URL: $URL"
        RESPONSE=$(curl -s $URL)
        echo "Response: $RESPONSE"

    # ======================================================================
    #                    AZURE APP SERVICE DEPLOYMENT
    # ======================================================================
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create --name helloworld-rg --location eastus

    - name: Create App Service Plan (Linux)
      run: |
        az appservice plan create \
          --name helloworld-asp \
          --resource-group helloworld-rg \
          --sku B1 \
          --is-linux || true

    - name: Create Azure Web App (from Docker Hub)
      run: |
        WEBAPP_NAME="helloworld-${{ github.run_id }}"
        echo "WEBAPP_NAME=$WEBAPP_NAME" >> $GITHUB_ENV

        az webapp create \
          --resource-group helloworld-rg \
          --plan helloworld-asp \
          --name $WEBAPP_NAME \
          --deployment-container-image-name ${{ secrets.DOCKERHUB_USERNAME }}/helloworld-app:latest

    - name: Configure Azure Web App Port
      run: |
        az webapp config appsettings set \
          --resource-group helloworld-rg \
          --name ${{ env.WEBAPP_NAME }} \
          --settings WEBSITES_PORT=8080

    # --- OPTIONAL: Restrict Traffic to specific IP ranges ---
    # az webapp config access-restriction add \
    #   --resource-group helloworld-rg \
    #   --name $WEBAPP_NAME \
    #   --rule-name "OfficeIP" \
    #   --action Allow \
    #   --ip-address 123.45.67.89 \
    #   --priority 100

    # --- OPTIONAL: Enable Autoscaling ---
    # az monitor autoscale create \
    #   --resource-group helloworld-rg \
    #   --resource helloworld-asp \
    #   --resource-type Microsoft.Web/serverfarms \
    #   --name autoscale-rule \
    #   --min-count 1 \
    #   --max-count 5 \
    #   --count 1
    #
    # az monitor autoscale rule create \
    #   --resource-group helloworld-rg \
    #   --autoscale-name autoscale-rule \
    #   --condition "Percentage CPU > 70 avg 5m" \
    #   --scale out 1

    - name: Display Azure URL
      run: |
        URL=https://${{ env.WEBAPP_NAME }}.azurewebsites.net
        echo "Azure App URL: $URL"
        curl -I $URL
