name: Deploy to GCP and Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # <-- enables Run Workflow button

jobs:
  multicloud-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------------------------------
    # CHECKOUT REPOSITORY
    # ---------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------------------------------
    # NODE DEPENDENCY CHECK
    # ---------------------------------------------------
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Install dependencies
      run: npm install

    - name: Dependency Vulnerability Check
      run: npm audit --audit-level=high

    # ---------------------------------------------------
    # BUILD DOCKER IMAGE (COMMON FOR BOTH CLOUDS)
    # ---------------------------------------------------
    - name: Build Docker image
      run: docker build -t helloworld-app .

    # ======================================================================
    #                    ðŸ“Œ OPTIONAL SECURITY BLOCK (COMMENTED)
    # ======================================================================
    # --- START :: DOCKER IMAGE SECURITY SCAN (TRIVY) ---
    # - name: Security Scan Docker Image
    #   uses: aquasecurity/trivy-action@master
    #   with:
    #     image-ref: helloworld-app
    #     severity: HIGH,CRITICAL
    #     exit-code: 0
    # --- END :: DOCKER IMAGE SECURITY SCAN ---
    # ======================================================================

    # ======================================================================
    #                    GCP CLOUD RUN DEPLOYMENT
    # ======================================================================

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Push to GCP Artifact Registry
      run: |
        docker tag helloworld-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: helloworld-cloudrun
        region: us-central1
        image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        flags: --allow-unauthenticated --port=8080

    # ======================================================================
    #                   ðŸ“Œ OPTIONAL GCP AUTOSCALING BLOCK
    # ======================================================================
    # --- START :: GCP CLOUD RUN AUTOSCALING ---
    # - name: Configure Cloud Run Autoscaling
    #   run: |
    #     gcloud run services update helloworld-cloudrun \
    #       --region us-central1 \
    #       --min-instances 1 \
    #       --max-instances 5 \
    #       --concurrency 80 \
    #       --cpu-throttling
    # --- END :: GCP CLOUD RUN AUTOSCALING ---
    # ======================================================================

    - name: Verify Cloud Run Web App on Port 8080
      run: |
        SERVICE_URL=$(gcloud run services describe helloworld-cloudrun --region us-central1 --format='value(status.url)')
        echo "GCP_URL=$SERVICE_URL" >> $GITHUB_ENV
        echo "Cloud Run Service URL: $SERVICE_URL"
        echo ""
        echo "Testing web app response..."
        RESPONSE=$(curl -s "$SERVICE_URL")
        if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
          echo "Web app is successfully hosting on port 8080"
          echo "HTML content verified"
          echo ""
          echo "Web app is serving styled HTML page with welcome message"
        else
          echo "Web app verification failed"
          exit 1
        fi

    # ======================================================================
    #                    AZURE APP SERVICE DEPLOYMENT
    # ======================================================================

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Register Required Azure Resource Providers
      run: |
        echo "Registering Microsoft.ContainerRegistry provider..."
        az provider register --namespace Microsoft.ContainerRegistry --wait
        echo "Registering Microsoft.Web provider..."
        az provider register --namespace Microsoft.Web --wait
        echo "Resource providers registered"

    - name: Set Azure resource names (use existing plan)
      run: |
        RG="multi-cloud-demo"
        PLAN="ASP-multiclouddemo-b415"
        echo "AZURE_RESOURCE_GROUP=$RG" >> $GITHUB_ENV
        echo "AZURE_APP_SERVICE_PLAN=$PLAN" >> $GITHUB_ENV
        LOCATION=$(az group show --name "$RG" --query location -o tsv 2>/dev/null || echo "")
        if [ -n "$LOCATION" ]; then
          echo "AZURE_REGION=$LOCATION" >> $GITHUB_ENV
          echo "Detected resource group location: $LOCATION"
        else
          echo "AZURE_REGION=" >> $GITHUB_ENV

    - name: Find or Create Azure Resource Group
      run: |
        RG=${{ env.AZURE_RESOURCE_GROUP }}
        if [ -n "$RG" ] && az group exists --name "$RG"; then
          echo "Resource group $RG already exists. Using existing group."
          LOCATION=$(az group show --name "$RG" --query location -o tsv)
          echo "AZURE_REGION=$LOCATION" >> $GITHUB_ENV
        else
          RG="helloworld-rg"
          REGIONS=("eastus" "westus" "southcentralus" "canadacentral" "northeurope" "westeurope")
          SELECTED_REGION=""
          echo "Attempting to find available region..."
          for region in "${REGIONS[@]}"; do
            echo "Trying region: $region"
            if az group create --name $RG --location $region 2>&1 | grep -q "created\|already exists"; then
              SELECTED_REGION=$region
              echo "Using region: $SELECTED_REGION"
              echo "AZURE_REGION=$SELECTED_REGION" >> $GITHUB_ENV
              break
            fi
          done
          if [ -z "$SELECTED_REGION" ]; then
            echo "âŒ No available region found."
            exit 1
          fi
          echo "AZURE_RESOURCE_GROUP=$RG" >> $GITHUB_ENV
        fi

    - name: Create or Use Existing Azure Container Registry
      run: |
        ACR_NAME="helloworldacr084"
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
        
        if az acr show --name $ACR_NAME --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &>/dev/null; then
          echo "ACR $ACR_NAME already exists"
        else
          echo "Creating new ACR: $ACR_NAME"
          az acr create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name $ACR_NAME \
            --sku Basic
        fi

    - name: Enable ACR Admin and Login
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        az acr update -n $ACR_NAME --admin-enabled true
        az acr login --name $ACR_NAME

    - name: Build and Push Docker Image to ACR
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        docker build -t ${ACR_NAME}.azurecr.io/helloworld-app:latest .
        docker push ${ACR_NAME}.azurecr.io/helloworld-app:latest

    # ======================================================================
    #      ðŸ“Œ OPTIONAL ACR SECURITY CHECK (COMMENTED)
    # ======================================================================
    # --- START :: ACR IMAGE SECURITY SCAN ---
    # - name: Scan Image in ACR
    #   run: |
    #     az acr run --registry ${{ env.ACR_NAME }} --cmd "trivy fs /" /dev/null
    # --- END :: ACR IMAGE SECURITY SCAN ---
    # ======================================================================

    - name: Create Azure Web App
      run: |
        WEBAPP_NAME="helloworld-2603"
        echo "WEBAPP_NAME=$WEBAPP_NAME" >> $GITHUB_ENV

        ACR_NAME=${{ env.ACR_NAME }}
        IMAGE_NAME=${ACR_NAME}.azurecr.io/helloworld-app:latest

        if az webapp show --name $WEBAPP_NAME --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &>/dev/null; then
          echo "Web app $WEBAPP_NAME already exists"
        else
          az webapp create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --plan ${{ env.AZURE_APP_SERVICE_PLAN }} \
            --name $WEBAPP_NAME \
            --deployment-container-image-name $IMAGE_NAME
        fi

        az webapp identity assign --name $WEBAPP_NAME --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

        PRINCIPAL_ID=$(az webapp identity show --name $WEBAPP_NAME --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query principalId -o tsv)
        ACR_ID=$(az acr show --name $ACR_NAME --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query id -o tsv)
        az role assignment create --assignee $PRINCIPAL_ID --role AcrPull --scope $ACR_ID 2>/dev/null || true

    - name: Configure Web App Container Settings
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        REGISTRY_URL="https://${ACR_NAME}.azurecr.io"
        IMAGE="${ACR_NAME}.azurecr.io/helloworld-app:latest"

        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --container-image-name $IMAGE \
          --container-registry-url $REGISTRY_URL

    - name: Configure Port and Restart Web App
      run: |
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings WEBSITES_PORT=8080

        az webapp restart --name $WEBAPP_NAME --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

        sleep 30

    # ======================================================================
    #            ðŸ“Œ OPTIONAL AZURE AUTOSCALE BLOCK (COMMENTED)
    # ======================================================================
    # --- START :: ENABLE AUTOSCALE FOR APP SERVICE PLAN ---
    # - name: Enable Azure App Service Autoscaling
    #   run: |
    #     az monitor autoscale create \
    #       --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
    #       --resource ${{ env.AZURE_APP_SERVICE_PLAN }} \
    #       --resource-type "Microsoft.Web/serverfarms" \
    #       --name "autoscale-rule" \
    #       --min-count 1 \
    #       --max-count 3 \
    #       --count 1
    #
    #     az monitor autoscale rule create \
    #       --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
    #       --autoscale-name "autoscale-rule" \
    #       --scale out 1 \
    #       --condition "Percentage CPU > 70 avg 5m"
    #
    #     az monitor autoscale rule create \
    #       --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
    #       --autoscale-name "autoscale-rule" \
    #       --scale in 1 \
    #       --condition "Percentage CPU < 30 avg 10m"
    # --- END :: ENABLE AUTOSCALE ---
    # ======================================================================

    - name: Display and Verify Azure Web App URL
      run: |
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        AZURE_URL="https://${WEBAPP_NAME}.azurewebsites.net"
        echo "Azure Web App URL: $AZURE_URL"
        echo "Testing web app endpoint..."

        for i in {1..10}; do
          echo "Attempt $i"
          RESPONSE=$(curl -s -m 5 "$AZURE_URL" 2>/dev/null) || true
          if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
            echo "Azure Web App is running"
            exit 0
          fi
          sleep 5
        done
        echo "Web app may still be starting. Check manually: $AZURE_URL"

    - name: Deployment Complete
      run: echo "Deployment complete."
