name: Deploy to GCP and Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # <-- enables Run Workflow button

jobs:
  multicloud-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------------------------------
    # CHECKOUT REPOSITORY
    # ---------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------------------------------
    # NODE DEPENDENCY CHECK
    # ---------------------------------------------------
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Install dependencies
      run: npm install

    - name: Dependency Vulnerability Check
      run: npm audit --audit-level=high

    # ---------------------------------------------------
    # BUILD DOCKER IMAGE (COMMON FOR BOTH CLOUDS)
    # ---------------------------------------------------
    - name: Build Docker image
      run: docker build -t helloworld-app .

    # ======================================================================
    #                    GCP CLOUD RUN DEPLOYMENT
    # ======================================================================

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Push to GCP Artifact Registry
      run: |
        docker tag helloworld-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: helloworld-cloudrun
        region: us-central1
        image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        flags: --allow-unauthenticated --port=8080

    - name: Verify Cloud Run Web App on Port 8080
      run: |
        SERVICE_URL=$(gcloud run services describe helloworld-cloudrun --region us-central1 --format='value(status.url)')
        echo "GCP_URL=$SERVICE_URL" >> $GITHUB_ENV
        echo "Cloud Run Service URL: $SERVICE_URL"
        echo ""
        echo "Testing web app response..."
        RESPONSE=$(curl -s "$SERVICE_URL")
        if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
          echo "âœ… Web app is successfully hosting on port 8080"
          echo "âœ… HTML content verified"
          echo ""
          echo "Web app is serving styled HTML page with welcome message"
        else
          echo "âŒ Web app verification failed"
          exit 1
        fi

    # ======================================================================
    #                    AZURE APP SERVICE DEPLOYMENT
    # ======================================================================

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Register Required Azure Resource Providers
      run: |
        echo "Registering Microsoft.ContainerRegistry provider..."
        az provider register --namespace Microsoft.ContainerRegistry --wait
        echo "Registering Microsoft.Web provider..."
        az provider register --namespace Microsoft.Web --wait
        echo "âœ… Resource providers registered"

    - name: Find Available Azure Region and Create Resource Group
      run: |
        REGIONS=("eastus" "westus" "southcentralus" "canadacentral" "northeurope" "westeurope")
        SELECTED_REGION=""
        
        echo "Attempting to find available region for deployment..."
        for region in "${REGIONS[@]}"; do
          echo "Trying region: $region"
          if az group create --name helloworld-rg --location $region 2>&1 | grep -q "created\|already exists"; then
            SELECTED_REGION=$region
            echo "âœ… Using region: $SELECTED_REGION"
            echo "AZURE_REGION=$SELECTED_REGION" >> $GITHUB_ENV
            break
          fi
        done
        
        if [ -z "$SELECTED_REGION" ]; then
          echo "âŒ No available region found. All regions exhausted or error occurred."
          exit 1
        fi

    - name: Create Azure Container Registry
      run: |
        ACR_NAME="helloworldacr$(date +%s | tail -c 4)"
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
        az acr create \
          --resource-group helloworld-rg \
          --name $ACR_NAME \
          --sku Basic

    - name: Login to ACR and Build & Push Docker Image
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        echo "Using ACR: $ACR_NAME"
        # Login to ACR (establish Docker credentials)
        az acr login --name $ACR_NAME

        # Build the Docker image locally on the runner and tag for ACR
        docker build -t ${ACR_NAME}.azurecr.io/helloworld-app:latest .

        # Push the image to ACR
        docker push ${ACR_NAME}.azurecr.io/helloworld-app:latest
    - name: Create App Service Plan (B1 - Basic Tier)
      run: |
        echo "Creating App Service Plan with B1 Basic tier..."
        echo "Plan Name: helloworld-asp"
        echo "SKU: B1 (Basic - 1 vCPU, 1.75 GB RAM)"
        echo "Features: Custom domains, SSL, autoscaling, 5 app deployments"
        echo ""
        
        az appservice plan create \
          --name helloworld-asp \
          --resource-group helloworld-rg \
          --sku B1 \
          --is-linux
        
        if [ $? -eq 0 ]; then
          echo "âœ… App Service Plan created successfully with B1 tier"
          echo ""
          echo "Plan Details:"
          az appservice plan show --name helloworld-asp --resource-group helloworld-rg --query "{Name:name, SKU:sku.name, Tier:sku.tier}"
        else
          echo "âŒ Failed to create B1 plan. Check quota limits."
          exit 1
        fi

    - name: Create Azure Web App
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        echo "WEBAPP_NAME=$WEBAPP_NAME" >> $GITHUB_ENV
        
        az webapp create \
          --resource-group helloworld-rg \
          --plan helloworld-asp \
          --name $WEBAPP_NAME

    - name: Configure Web App Container Settings (ACR)
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        REGISTRY_URL="https://${ACR_NAME}.azurecr.io"
        USERNAME=$(az acr credential show -n $ACR_NAME --query "username" -o tsv)
        PASSWORD=$(az acr credential show -n $ACR_NAME --query "passwords[0].value" -o tsv)
        
        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group helloworld-rg \
          --docker-custom-image-name ${ACR_NAME}.azurecr.io/helloworld-app:latest \
          --docker-registry-server-url $REGISTRY_URL \
          --docker-registry-server-user $USERNAME \
          --docker-registry-server-password $PASSWORD

    - name: Configure Port and Enable Container Restart
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        echo "Configuring web app settings for $WEBAPP_NAME..."
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group helloworld-rg \
          --settings WEBSITES_PORT=8080
        
        echo "Restarting web app to apply settings..."
        az webapp restart \
          --name $WEBAPP_NAME \
          --resource-group helloworld-rg
        
        echo "Waiting for web app to fully start..."
        sleep 30

    - name: Display and Verify Azure Web App URL
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        AZURE_URL="https://${WEBAPP_NAME}.azurewebsites.net"
        echo "âœ… Azure Web App Successfully Deployed!"
        echo ""
        echo "ğŸŒ Azure Web App URL: $AZURE_URL"
        echo ""
        echo "Testing web app endpoint..."
        
        # Retry logic for web app startup
        for i in {1..15}; do
          echo "Attempt $i: Testing connection..."
          if RESPONSE=$(curl -s -m 5 "$AZURE_URL" 2>/dev/null); then
            if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
              echo "âœ… Azure Web App is running on port 8080"
              echo "âœ… HTML content verified"
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ… DEPLOYMENT SUCCESSFUL"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "Web App URL: $AZURE_URL"
              exit 0
            fi
          fi
          if [ $i -lt 15 ]; then
            echo "Web app starting up, waiting..."
            sleep 10
          fi
        done
        echo "â³ Web app still initializing. It may take a few more minutes to fully start."
        echo "Check the URL manually: $AZURE_URL"

    # ======================================================================
    #                    DEPLOYMENT SUMMARY
    # ======================================================================
    - name: Multi-Cloud Deployment Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         ğŸš€ MULTI-CLOUD DEPLOYMENT COMPLETE ğŸš€             â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… GCP CLOUD RUN"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        GCP_URL=${{ env.GCP_URL }}
        echo "URL: $GCP_URL"
        echo "Region: us-central1"
        echo "Status: âœ… Running on port 8080"
        echo ""
        
        echo "âœ… AZURE APP SERVICE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        AZURE_URL="https://${WEBAPP_NAME}.azurewebsites.net"
        echo "URL: $AZURE_URL"
        echo "Region: ${{ env.AZURE_REGION }}"
        echo "Plan: B1 (Basic - 1 vCPU, 1.75 GB RAM)"
        echo "Status: âœ… Running on port 8080"
        echo ""
        
        echo "ğŸ”— TEST YOUR DEPLOYMENT"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "GCP Cloud Run:    curl $GCP_URL"
        echo "Azure App Service: curl $AZURE_URL"
        echo ""
        
        echo "ğŸ“Š DEPLOYMENT DETAILS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"
        echo "Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "âœ¨ Both deployments are live and serving your web app! âœ¨"

