name: Deploy to GCP and Azure

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # <-- enables Run Workflow button

jobs:
  multicloud-deploy:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------------------------------
    # CHECKOUT REPOSITORY
    # ---------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------------------------------
    # NODE DEPENDENCY CHECK
    # ---------------------------------------------------
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"

    - name: Install dependencies
      run: npm install

    - name: Dependency Vulnerability Check
      run: npm audit --audit-level=high

    # ---------------------------------------------------
    # BUILD DOCKER IMAGE (COMMON FOR BOTH CLOUDS)
    # ---------------------------------------------------
    - name: Build Docker image
      run: docker build -t helloworld-app .

    # ======================================================================
    #                    GCP CLOUD RUN DEPLOYMENT
    # ======================================================================

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Push to GCP Artifact Registry
      run: |
        docker tag helloworld-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest

    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: helloworld-cloudrun
        region: us-central1
        image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helloworld-repo/helloworld-app:latest
        flags: --allow-unauthenticated --port=8080

    - name: Verify Cloud Run Web App on Port 8080
      run: |
        SERVICE_URL=$(gcloud run services describe helloworld-cloudrun --region us-central1 --format='value(status.url)')
        echo "Cloud Run Service URL: $SERVICE_URL"
        echo ""
        echo "Testing web app response..."
        RESPONSE=$(curl -s "$SERVICE_URL")
        if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
          echo "✅ Web app is successfully hosting on port 8080"
          echo "✅ HTML content verified"
          echo ""
          echo "Web app is serving styled HTML page with welcome message"
        else
          echo "❌ Web app verification failed"
          exit 1
        fi

    # ======================================================================
    #                    AZURE APP SERVICE DEPLOYMENT
    # ======================================================================

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Azure Resource Group
      run: |
        az group create \
          --name helloworld-rg \
          --location eastus

    - name: Create Azure Container Registry
      run: |
        ACR_NAME="helloworldacr$(date +%s | tail -c 4)"
        echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
        az acr create \
          --resource-group helloworld-rg \
          --name $ACR_NAME \
          --sku Basic

    - name: Login to ACR and Build & Push Docker Image
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        echo "Using ACR: $ACR_NAME"
        # Login to ACR (establish Docker credentials)
        az acr login --name $ACR_NAME

        # Build the Docker image locally on the runner and tag for ACR
        docker build -t ${ACR_NAME}.azurecr.io/helloworld-app:latest .

        # Push the image to ACR
        docker push ${ACR_NAME}.azurecr.io/helloworld-app:latest

    - name: Check Subscription Quota & Create App Service Plan
      run: |
        echo "Attempting to create App Service Plan (B1 - Basic tier)..."
        echo ""
        
        # Try to create the plan with error handling
        if az appservice plan create \
          --name helloworld-asp \
          --resource-group helloworld-rg \
          --sku B1 \
          --is-linux 2>&1; then
          echo "✅ App Service Plan created successfully"
        else
          echo "⚠️  B1 tier creation failed (possible quota limit)"
          echo ""
          echo "SOLUTION OPTIONS:"
          echo "1. Request a quota increase via Azure Support:"
          echo "   https://portal.azure.com -> Help + Support -> New Support Request"
          echo "   Set 'Issue type' to 'Service and subscription limits (quotas)'"
          echo "   Request: 'Increase App Service Plan quota for Free/Shared tier in eastus'"
          echo ""
          echo "2. Try deploying to a different region (westus, southcentralus, etc.)"
          echo ""
          echo "3. Use F1 Free tier (1 free app per subscription limit):"
          echo "   Retrying with F1 Free tier..."
          az appservice plan create \
            --name helloworld-asp \
            --resource-group helloworld-rg \
            --sku F1 \
            --is-linux || {
            echo "❌ Both B1 and F1 plans failed. Quota likely needs increase."
            exit 1
          }
        fi

    - name: Create Azure Web App
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        echo "WEBAPP_NAME=$WEBAPP_NAME" >> $GITHUB_ENV
        
        az webapp create \
          --resource-group helloworld-rg \
          --plan helloworld-asp \
          --name $WEBAPP_NAME

    - name: Configure Web App Container Settings (ACR)
      run: |
        ACR_NAME=${{ env.ACR_NAME }}
        WEBAPP_NAME=${{ env.WEBAPP_NAME }}
        REGISTRY_URL="https://${ACR_NAME}.azurecr.io"
        USERNAME=$(az acr credential show -n $ACR_NAME --query "username" -o tsv)
        PASSWORD=$(az acr credential show -n $ACR_NAME --query "passwords[0].value" -o tsv)
        
        az webapp config container set \
          --name $WEBAPP_NAME \
          --resource-group helloworld-rg \
          --docker-custom-image-name ${ACR_NAME}.azurecr.io/helloworld-app:latest \
          --docker-registry-server-url $REGISTRY_URL \
          --docker-registry-server-user $USERNAME \
          --docker-registry-server-password $PASSWORD

    - name: Configure Port and Deploy
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group helloworld-rg \
          --settings WEBSITES_PORT=8080

    - name: Display Azure Web App URL
      run: |
        WEBAPP_NAME="helloworld-app-${{ github.run_id }}"
        AZURE_URL="https://${WEBAPP_NAME}.azurewebsites.net"
        echo "✅ Azure Web App Successfully Deployed!"
        echo ""
        echo "Azure Web App URL: $AZURE_URL"
        echo ""
        echo "Testing web app..."
        sleep 10
        RESPONSE=$(curl -s "$AZURE_URL")
        if echo "$RESPONSE" | grep -q "Welcome to Samiksha's Web App"; then
          echo "✅ Azure Web App is running on port 8080"
          echo "✅ HTML content verified"
        else
          echo "⏳ Web app may still be starting up"
        fi
